theta=list()
theta.tr=vector("list")
# liv=as.integer(59+npar)
# iv=integer(59+npar)
# lv=as.integer(lv)
# v=double(lv)
# lloc=10
# cRep=cumsum(Rep)
# cRep= c(0,cRep)
# G=2;K=2;
tol=1e-08
oldll=-Inf
# iv[1]=0
# j=0
Z=array(1,c(N,sum(Rep)))
u <- Uhat(X)
idx=rep(1:M,Rep)
View(X)
View(u)
Uhat
View(u)
u <- Uhat(X)
idx=rep(1:M,Rep)
out1=vector("list",length(idx))
theta1=vector("list",length(idx))
for(i in 1:length(idx)){
out1[[i]]$lambda=c(pg[1],pg[2]*pkgm[idx[i],])
out1[[i]]$mu=c(0,mg[idx[i]],mum[idx[i]])
out1[[i]]$sigma=c(1,1,sqrt(s2m[idx[i]]))
}
id=cumsum(Rep)
idx=rep(1:M,Rep)
theta1=vector("list",M)
mix=vector("list",M)
out1
qgmm.marginal
u[,(id[m]-Rep[m]+1):id[m]]
id=cumsum(Rep)
idx=rep(1:M,Rep)
theta1=vector("list",M)
mix=vector("list",M)
for (m in 1:M){
theta1[[m]]$pie=c(pg[1],pg[2]*pkgm[idx[i],])
theta1[[m]]$mu[[1]]=rep(0,Rep[m])
theta1[[m]]$mu[[2]]=rep(mg[m],Rep[m])
theta1[[m]]$mu[[3]]=rep(mum[1],Rep[m])
theta1[[m]]$sigma[[1]]=rep(1,Rep[m])
theta1[[m]]$sigma[[2]]=rep(1,Rep[m])
theta1[[m]]$sigma[[3]]=rep((s2m[m]),Rep[m])
mix[[m]]=out1[[idx[idx==m][1]]]
###
Z[,(id[m]-Rep[m]+1):id[m]] <- qgmm.marginal(u[,(id[m]-Rep[m]+1):id[m]], theta1[[m]],mix[[m]], res = 1000, spread = 5)
}
qgmm.marginal <- function (u, theta, mix,res = 1000, spread = 5) {
d <- dim(u)[2]
m <- length(c(theta$pie))
n.samples <- round(res * theta$pie)
n.samples[n.samples == 0] <- 2
# Create grid of evalutation
s <- NULL
for (i in 1:d) {
for (j in 1:m) {
m.ij <- theta$mu[[j]][i]
sd.ij <- sqrt(theta$sigma[[j]][i])
s <- c(s, seq(m.ij-spread*sd.ij, m.ij+spread*sd.ij, l = n.samples[j]))
}
}
dim(s) <- c(sum(n.samples), d)
# Evaluate on cdf on the grid
eval=array(NA,dim(s))
for (j in 1:d){
eval[,j] <- pnormmix(s[,j],mix)
}
#pgmm_marginal(z = s, mus = theta$mu, sigmas = theta$sigma, pie = theta$pie)
# Invert function
z.out <- NULL
for (j in 1:d) {
z.out <- c(z.out, approxfun(eval[, j], s[, j], rule = 2)(u[, j]))
}
z.out.is.na <- is.na(z.out)
if (any(z.out.is.na)) {
z.out[z.out.is.na & u >= 1] <- Inf
z.out[z.out.is.na & u <= 0] <- -Inf
}
dim(z.out) <- c(nrow(u),d)
return(z.out)
}
id=cumsum(Rep)
idx=rep(1:M,Rep)
theta1=vector("list",M)
mix=vector("list",M)
for (m in 1:M){
theta1[[m]]$pie=c(pg[1],pg[2]*pkgm[idx[i],])
theta1[[m]]$mu[[1]]=rep(0,Rep[m])
theta1[[m]]$mu[[2]]=rep(mg[m],Rep[m])
theta1[[m]]$mu[[3]]=rep(mum[1],Rep[m])
theta1[[m]]$sigma[[1]]=rep(1,Rep[m])
theta1[[m]]$sigma[[2]]=rep(1,Rep[m])
theta1[[m]]$sigma[[3]]=rep((s2m[m]),Rep[m])
mix[[m]]=out1[[idx[idx==m][1]]]
###
Z[,(id[m]-Rep[m]+1):id[m]] <- qgmm.marginal(u[,(id[m]-Rep[m]+1):id[m]], theta1[[m]],mix[[m]], res = 1000, spread = 5)
}
pnormmix <- function(x,mixture) {
lambda <- mixture$lambda
k <- length(lambda)
pnorm.from.mix <- function(x,component) {
lambda[component]*pnorm(x,mean=mixture$mu[component],
sd=mixture$sigma[component])
}
pnorms <- sapply(1:k,pnorm.from.mix,x=x)
if (length(x)==1){
return(sum(pnorms))
}else{
return(rowSums(pnorms))}
}
dnormmix <- function(x,mixture) {
lambda <- mixture$lambda
Wg1=array(NA,c(length(x),length(lambda)))
k <- length(lambda)
dnorm.from.mix <- function(x,component) {
log(lambda[component])+log(dnorm(x,mean=mixture$mu[component],
sd=mixture$sigma[component]))
}
dnorms1 <- sapply(1:k,dnorm.from.mix,x=x)
dnorm2=((apply((dnorms1),1,sumlog)))
return(dnorm2)
}
id=cumsum(Rep)
idx=rep(1:M,Rep)
theta1=vector("list",M)
mix=vector("list",M)
for (m in 1:M){
theta1[[m]]$pie=c(pg[1],pg[2]*pkgm[idx[i],])
theta1[[m]]$mu[[1]]=rep(0,Rep[m])
theta1[[m]]$mu[[2]]=rep(mg[m],Rep[m])
theta1[[m]]$mu[[3]]=rep(mum[1],Rep[m])
theta1[[m]]$sigma[[1]]=rep(1,Rep[m])
theta1[[m]]$sigma[[2]]=rep(1,Rep[m])
theta1[[m]]$sigma[[3]]=rep((s2m[m]),Rep[m])
mix[[m]]=out1[[idx[idx==m][1]]]
###
Z[,(id[m]-Rep[m]+1):id[m]] <- qgmm.marginal(u[,(id[m]-Rep[m]+1):id[m]], theta1[[m]],mix[[m]], res = 1000, spread = 5)
}
View(Z)
fn=function(par, Z,N,K,G,M,Rep){
pg=c(par[1],1-par[1])
pkgm=cbind(par[2:(1+M)],1-par[2:(1+M)])
mg=par[(M+2):(2*M+1)]
mum=par[(2*M+2):(3*M+1)]
s2m=par[(3*M+2):(4*M+1)]
rhom=par[(4*M+2):(5*M+1)]
cRep=cumsum(Rep)
cRep= c(0,cRep)
print(pg)
print(pkgm)
id=which(is.nan(pg)==TRUE)
id1=which(is.nan(pkgm)==TRUE)
#
# print(pg)
#print(pkgm)
#   if (is.finite(pg)) {
#     return(-loglik)
#   }
#   else {
#     return(1e+09)
#   }
Z=array(1,c(N,sum(Rep)))
u <- Uhat(X)
idx=rep(1:M,Rep)
out1=vector("list",length(idx))
theta1=vector("list",length(idx))
for(i in 1:length(idx)){
out1[[i]]$lambda=c(pg[1],pg[2]*pkgm[idx[i],])
out1[[i]]$mu=c(0,mg[idx[i]],mum[idx[i]])
out1[[i]]$sigma=c(1,1,sqrt(s2m[idx[i]]))
}
id=cumsum(Rep)
idx=rep(1:M,Rep)
theta1=vector("list",M)
mix=vector("list",M)
for (m in 1:M){
theta1[[m]]$pie=c(pg[1],pg[2]*pkgm[idx[i],])
theta1[[m]]$mu[[1]]=rep(0,Rep[m])
theta1[[m]]$mu[[2]]=rep(mg[m],Rep[m])
theta1[[m]]$mu[[3]]=rep(mum[1],Rep[m])
theta1[[m]]$sigma[[1]]=rep(1,Rep[m])
theta1[[m]]$sigma[[2]]=rep(1,Rep[m])
theta1[[m]]$sigma[[3]]=rep((s2m[m]),Rep[m])
mix[[m]]=out1[[idx[idx==m][1]]]
Z[,(id[m]-Rep[m]+1):id[m]] <- qgmm.marginal(u[,(id[m]-Rep[m]+1):id[m]], theta1[[m]],mix[[m]], res = 5000, spread = 3)
}
tmp=array(NA,dim(Z))
for (j in 1:dim(Z)[2]){
tmp[,j]    <- dnormmix(Z[,j],out1[[j]])}
WKg1=array(1,c(N,K,M))
norm1=array(1,c(N,M))
Wg1=array(1,c(N,G))
for (m in 1:M){
WKg1[,1,m]=log(dmvnorm(Z[,(cRep[m]+1):cRep[m+1]],rep(mg[m] ,Rep[m]),diag(Rep[m])))
Sig=matrix(rep(s2m[m]*rhom[m],Rep[m]^2),Rep[m],Rep[m])
diag(Sig)=rep(s2m[m],Rep[m])
#Sig=matrix(c(s2m[m],s2m[m]*rhom[m],s2m[m]*rhom[m],s2m[m]),2,2)
#Sig=e$vectors%*%diag(e$values)%*%t(e$vectors)
WKg1[,2,m]=log(dmvnorm(Z[,(cRep[m]+1):cRep[m+1]],rep(mum[m] ,Rep[m]),Sig))
#WKg[WKg<1e-05]=1e-05
e=as.matrix(WKg1[,,m])
ind=(e<(-7.0e2));
U=exp((-7.0e2)*ind+WKg1[,,m]*(1-ind))%*%diag(pkgm[m,]);
norm1[,m]=apply(U,1,sum)
}
#
#g=0 & g=1
w=dmvnorm(Z);
#w[w<.Machine$double.eps]=.Machine$double.eps
Wg1[,1]=log(w);
#norm1[norm1<.Machine$double.eps]=.Machine$double.eps
Wg1[,2]=   log(apply((norm1),1,prod))
ind=(Wg1<(-7.0e2));
U=exp((-7.0e2)*ind+Wg1*(1-ind))%*%diag(pg);
#Wg1[Wg1<-150]=-150
#   ind=matrix(0,N,G)
#   for (g in 1:G){
#     ind[Wg1[,g]<-7.0e2,g]=1;
#   }
#
#
#   Wg1=(-7.0e2*ind+Wg1*(1-ind));
#
#print(Wg1)
lik=((apply(U,1,sum)))
#lik[lik<.Machine$double.eps]=.Machine$double.eps
#tmp[tmp<.Machine$double.eps]=.Machine$double.eps;
loglik <-sum(log(lik))- sum(rowSums((tmp)))
f=-loglik
if (is.finite(loglik)) {
return(-loglik)
}
else {
return(1e+09)
}
}
j=1
j=j+1
para0=c((pg[1]), (t(pkgm[,1])),mg,mum,s2m,rhom)
l=c(0.05,rep(0.05,M),rep(.Machine$double.eps,2*M),rep(0.05,M),rep(0.01,M))
up=c(.85,rep(.85,M),rep(10,2*M),rep(20,M),rep(.99,M))
###
output= nlminb(para0, fn, Z=Z,N=N,K=K,G=G,M=M,Rep=Rep,
scale = 1, lower =l, upper = up,
control = list(eval.max=1,iter.max=3))
para0
install.packages("D:/R_work/IDR_mutilab/package/newIDRcode.tar.gz", repos = NULL, type = "source")
ss
data.frame(ID=c(1:5),drug_A,drug_A_mg,drug_B,drug_B_mg,drug_C,drug_C_mg)
drug_A <- c(1,0,0,0,0)
drug_A_mg <- c(20,0,0,0,0)
drug_B <- c(0,1,1,0,0)
drug_B_mg <- c(0,10,10,0,0)
drug_C <- c(0,0,0,1,1)
drug_C_mg <- c(0,0,0,5,5)
dat <- data.frame(ID=c(1:5),drug_A,drug_A_mg,drug_B,drug_B_mg,drug_C,drug_C_mg)
View(dat)
drug_A <- c(1,0,0,0,0)
drug_A_mg <- c(20,0,0,0,0)
drug_B <- c(0,1,1,0,0)
drug_B_mg <- c(0,10,10,0,0)
drug_C <- c(0,0,0,1,1)
drug_C_mg <- c(0,0,0,5,5)
dat <- data.frame(ID=c(1:5),drug_A,drug_A_mg,drug_B,drug_B_mg,drug_C,drug_C_mg)
drug_name <- c("A","B","C")
drug_name[1]
index <- matrix(0,nc=2,nr=length(drug_name))
paste("drug_",drug_name[1],sep="")
colname(dat)==paste("drug_",drug_name[1],sep="")
colnames(dat)==paste("drug_",drug_name[1],sep="")
which(colnames(dat)==paste("drug_",drug_name[1],sep=""))
drug_A <- c(1,0,0,0,0)
drug_A_mg <- c(20,0,0,0,0)
drug_B <- c(0,1,1,0,0)
drug_B_mg <- c(0,10,10,0,0)
drug_C <- c(0,0,0,1,1)
drug_C_mg <- c(0,0,0,5,5)
dat <- data.frame(ID=c(1:5),drug_A,drug_A_mg,drug_B,drug_B_mg,drug_C,drug_C_mg)
drug_name <- c("A","B","C")
index <- matrix(0,nc=2,nr=length(drug_name))
for (i in 1:length(drug_name)){
index[i,1] <- which(colnames(dat)==paste("drug_",drug_name[1],sep=""))
index[i,2] <- which(colnames(dat)==paste("drug_",drug_name[1],"_mg",sep=""))
}
index
index[i,1] <- which(colnames(dat)==paste("drug_",drug_name[i],sep=""))
index[i,2] <- which(colnames(dat)==paste("drug_",drug_name[i],"_mg",sep=""))
for (i in 1:length(drug_name)){
index[i,1] <- which(colnames(dat)==paste("drug_",drug_name[i],sep=""))
index[i,2] <- which(colnames(dat)==paste("drug_",drug_name[i],"_mg",sep=""))
}
for (i in 1:length(drug_name)){
index[i,1] <- which(colnames(dat)==paste("drug_",drug_name[i],sep=""))
index[i,2] <- which(colnames(dat)==paste("drug_",drug_name[i],"_mg",sep=""))
}
index
index <- data.frame(name=drug_name,index)
index
i=i
j=1
dat[1,]
index[j,]
index[j,2]
dat[i,index[j,2]]
index[j,1]
drug_A <- c(1,0,0,0,0)
drug_A_mg <- c(20,0,0,0,0)
drug_B <- c(0,1,1,0,0)
drug_B_mg <- c(0,10,10,0,0)
drug_C <- c(0,0,0,1,1)
drug_C_mg <- c(0,0,0,5,5)
dat <- data.frame(ID=c(1:5),drug_A,drug_A_mg,drug_B,drug_B_mg,drug_C,drug_C_mg)
drug_name <- c("A","B","C")
index <- matrix(0,nc=2,nr=length(drug_name))
for (i in 1:length(drug_name)){
index[i,1] <- which(colnames(dat)==paste("drug_",drug_name[i],sep=""))
index[i,2] <- which(colnames(dat)==paste("drug_",drug_name[i],"_mg",sep=""))
}
index <- data.frame(name=drug_name,index)
dat.dr<- NULL
dat.mg<- NULL
for(i in 1:dim(dat)[1]){
for (j in 1:dim(index)[1]){
if (dat[i,index[j,2]]==1){
dat.dr[i] <- index[j,1]
dat.mg[i] <- dat[i,index[j,3]]
}
}
}
dar.dr
dat.dr
dat.mg
dat2 <- data.frame(dat$ID,drug_name=dat,dr,drug_mg=dat.mg)
dat2 <- data.frame(dat$ID,drug_name=dat.dr,drug_mg=dat.mg)
dat2
drug_A <- c(1,0,0,0,0)
drug_A_mg <- c(20,0,0,0,0)
drug_B <- c(0,1,1,0,0)
drug_B_mg <- c(0,10,10,0,0)
drug_C <- c(0,0,0,1,1)
drug_C_mg <- c(0,0,0,5,5)
dat <- data.frame(ID=c(1:5),drug_A,drug_A_mg,drug_B,drug_B_mg,drug_C,drug_C_mg)
drug_name <- c("A","B","C")
index <- matrix(0,nc=2,nr=length(drug_name))
for (i in 1:length(drug_name)){
index[i,1] <- which(colnames(dat)==paste("drug_",drug_name[i],sep=""))
index[i,2] <- which(colnames(dat)==paste("drug_",drug_name[i],"_mg",sep=""))
}
index <- data.frame(name=drug_name,index)
dat.dr<- NULL
dat.mg<- NULL
for(i in 1:dim(dat)[1]){
for (j in 1:dim(index)[1]){
if (dat[i,index[j,2]]==1){
dat.dr[i] <- as.character(index[j,1])
dat.mg[i] <- dat[i,index[j,3]]
}
}
}
dat2 <- data.frame(dat$ID,drug_name=dat.dr,drug_mg=dat.mg)
dat2
drug_A <- c(1,0,0,0,0)
drug_A_mg <- c(20,0,0,0,0)
drug_B <- c(0,1,1,0,0)
drug_B_mg <- c(0,10,10,0,0)
drug_C <- c(0,0,0,1,1)
drug_C_mg <- c(0,0,0,5,5)
dat <- data.frame(ID=c(1:5),drug_A,drug_A_mg,drug_B,drug_B_mg,drug_C,drug_C_mg)
drug_name <- c("A","B","C")
index <- matrix(0,nc=2,nr=length(drug_name))
for (i in 1:length(drug_name)){
index[i,1] <- which(colnames(dat)==paste("drug_",drug_name[i],sep=""))
index[i,2] <- which(colnames(dat)==paste("drug_",drug_name[i],"_mg",sep=""))
}
index
index <- data.frame(name=drug_name,index)
index
dim(dat)[1]
dim(index)[1]
index[j,2]
dat[i,index[j,2]]==1
as.character(index[j,1])
dat[i,index[j,3]]
for(i in 1:dim(dat)[1]){
for (j in 1:dim(index)[1]){
if (dat[i,index[j,2]]==1){
dat.dr[i] <- as.character(index[j,1])
dat.mg[i] <- dat[i,index[j,3]]
}
}
}
dat2 <- data.frame(dat$ID,drug_name=dat.dr,drug_mg=dat.mg)
x <- read.csv("StatesData.csv")
View(x)
x <- read.csv("StatesData.csv",header = F ,stringsAsFactors = F)
View(x)
x <- read.csv("StatesData.csv",header = F ,stringsAsFactors = F, comment.char = "#")
View(x)
x[1,]
x <- read.csv("StatesData.csv",header = F ,stringsAsFactors = F, comment.char = "# ")
x <- read.csv("StatesData.csv",header = F ,stringsAsFactors = F, comment.char = "#")
View(x)
x <- read.csv("StatesData.csv",header = F ,stringsAsFactors = F)
View(x)
x <- read.csv("StatesData.csv",header = F ,stringsAsFactors = F,comment.char = "#")
View(x)
x <- read.csv("StatesData.csv",header = F ,stringsAsFactors = F)
x0 <- read.csv("StatesData.csv",header = F ,stringsAsFactors = F)
View(x0)
x1 <- x0[c(4:dim(x0)[1]), c(2:dim(x0)[2])]
View(x1)
x0 <- read.csv("StatesData.csv",header = F ,stringsAsFactors = F)
x1 <- x0[c(5:dim(x0)[1]), c(2:dim(x0)[2])]
View(x1)
x0 <- read.csv("StatesData.csv",header = F ,stringsAsFactors = F, na.strings = T)
View(x0)
x0 <- read.csv("StatesData.csv",header = F ,stringsAsFactors = F, na.strings = T)
x1 <- x0[c(5:dim(x0)[1]), c(2:dim(x0)[2])]
x0 <- read.csv("StatesData.csv",header = F ,stringsAsFactors = F, blank.lines.skip =T)
x1 <- x0[c(5:dim(x0)[1]), c(2:dim(x0)[2])]
x0 <- read.csv("StatesData.csv",header = F ,stringsAsFactors = F)
View(x0)
x1 <- x0[c(5:dim(x0)[1]), c(2:10)]
View(x1)
View(x0)
colnames(x1) <- x0[,c(4, c(2:10)]
colnames(x1) <- x0[4, c(2:10)]
View(x1)
View(x1)
View(x0)
colnames(x1) <- x0[4, c(2:10)]
rownames(x1) <- x0[c(5:dim(x0)[1]), 1]
x0[c(5:dim(x0)[1]), 1]
View(x0)
colnames(x1) <- x0[4, c(2:10)]
rownames(x1) <- x0[c(5:55, 1]
colnames(x1) <- x0[4, c(2:10)]
rownames(x1) <- x0[c(5:55, 1)]
colnames(x1) <- x0[4, c(2:10)]
rownames(x1) <- x0[c(5:55), 1]
rownames(x1)
x0[c(5:55), 1]
View(x1)
is.na[x0]
x0 <- read.csv("StatesData.csv",header = F ,stringsAsFactors = F)
is.na(x0)
is.null(x0)
!is.na(x0)
colSums(!is.na(x0))
which(colSums(!is.na(x0))==0)
x0[-which(colSums(!is.na(x0))==0)]
x0[-which(colSums(!is.na(x0))==0)]
x0[-which(rowSums(!is.na(x0))==0)]
rowSums(!is.na(x0))
x0[-c(56:58)]
x0 <- read.csv("StatesData.csv",header = F ,stringsAsFactors = F)
x0[,-which(colSums(!is.na(x0))==0)]
x0[-c(56:58),]
x0 <- read.csv("StatesData.csv",header = F ,stringsAsFactors = F)
x0 <- x0[,-which(colSums(!is.na(x0))==0)]
View(x)
View(x0)
x0[56,]
x0[56,2]==NULL
is.null(x0[56,2])
is.na(x0[56,2])
x0 <- read.csv("StatesData.csv",header = F ,stringsAsFactors = F)
x0 <- x0[,-which(colSums(!is.na(x0))==0)]
x0 <- x0[-c(56:58),]
x1 <- x0[c(5:dim(x0)[1]), c(2:10)]
View(x0)
View(x0)
x1 <- x0[c(5:dim(x0)[1]), c(2:dim(x0)[2])]
View(x1)
colnames(x1) <- x0[4, dim(x0)[1])]
colnames(x1) <- x0[4, dim(x0)[1]]
View(x1)
x0[4, dim(x0)[1]]
View(x)
colnames(x1) <- x0[4, c(2:dim(x0)[1])]
c(2:dim(x0)[1])
colnames(x1) <- x0[4, c(2:dim(x0)[2])]
rownames(x1) <- x0[c(5:dim(x0)[2]), 1]
x0[c(5:dim(x0)[2]), 1]
rownames(x1) <- x0[c(5:dim(x0)[1]), 1]
View(x1)
View(x0)
x.comments <- x0 <- [,c(1:3)]
x.comments <- x0[,c(1:3)]
View(x.comments)
setwd("d:/R_work/CFGL/");
rm(list=ls(all=TRUE));
###########
document()
setwd("d:/R_work/CFGL/");
rm(list=ls(all=TRUE));
library("devtools")
library("roxygen2")
load("data/expr_bl500.Rdata")
source("R/funs_get_scr_mat.R")
source("R/get_scr_mat.R")
###########
document()
install("CFGL")
install("../CFGL")
library("CFGL")
